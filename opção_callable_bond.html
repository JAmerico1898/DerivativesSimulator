<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Callable Bond - A Opção do Emissor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Segoe UI', sans-serif; }
        
        /* Custom Slider */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 24px; width: 24px; border-radius: 50%;
            background: #ef4444; border: 2px solid #fff; cursor: pointer; margin-top: -10px;
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 6px; cursor: pointer; background: #334155; border-radius: 3px;
        }

        .alert-pulse { animation: pulse-red 2s infinite; }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        .stamp {
            border: 4px solid #ef4444;
            color: #ef4444;
            border-radius: 10px;
            text-transform: uppercase;
            font-weight: 900;
            transform: rotate(-15deg);
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
        }
        .stamp.visible { opacity: 1; transform: rotate(-15deg) scale(1); }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4">

    <div class="max-w-6xl w-full bg-slate-900 rounded-xl border border-slate-700 shadow-2xl overflow-hidden flex flex-col md:flex-row">
        
        <!-- Esquerda: O Mercado e o Gráfico -->
        <div class="p-6 md:w-1/2 border-b md:border-b-0 md:border-r border-slate-700 flex flex-col">
            <header class="mb-6">
                <div class="flex items-center gap-2 mb-2">
                    <span class="bg-red-600 text-white text-xs px-2 py-1 rounded font-bold">EXEMPLO B</span>
                    <span class="text-slate-400 text-xs uppercase tracking-widest">Callable Bond</span>
                </div>
                <h1 class="text-2xl font-bold text-white">Opção de Compra do Emissor</h1>
                <p class="text-sm text-slate-400 mt-2">O Investidor vendeu uma opção: O Emissor pode recomprar a dívida.</p>
            </header>

            <!-- Gráfico de Preço x Taxa -->
            <div class="relative bg-slate-800 rounded border border-slate-600 h-64 mb-6 overflow-hidden">
                <div class="absolute top-2 left-2 text-[10px] text-slate-500">Curva de Preço do Título</div>
                <canvas id="priceCanvas" width="500" height="250" class="w-full h-full"></canvas>
                <!-- Label Flutuante -->
                <div id="graph-label" class="absolute bg-slate-900/80 px-2 py-1 rounded text-xs text-white pointer-events-none transition-all duration-100" style="top:0; left:0;"></div>
            </div>

            <!-- Controle: Taxa de Juros -->
            <div class="bg-slate-800 p-4 rounded-lg border border-slate-600 mt-auto">
                <div class="flex justify-between mb-2">
                    <!-- CORREÇÃO: Esquerda agora é Juros Baixos -->
                    <span class="text-xs text-slate-400">Juros Baixos (Título caro)</span>
                    
                    <span class="text-sm font-bold text-white" id="rate-display">Taxa de Mercado: 10.0%</span>
                    
                    <!-- CORREÇÃO: Direita agora é Juros Altos -->
                    <span class="text-xs text-slate-400">Juros Altos (Título barato)</span>
                </div>
                <!-- CORREÇÃO: Removido dir="rtl" para o slider crescer para a direita -->
                <input type="range" id="rate-slider" min="2" max="15" step="0.1" value="10">
                
                <div class="flex justify-between mt-1 text-[10px] text-slate-500">
                    <span>2%</span> <!-- Agora alinhado com o Min do slider -->
                    <span>Refinanciamento Barato &larr; &rarr; Dívida Cara</span>
                    <span>15%</span> <!-- Agora alinhado com o Max do slider -->
                </div>
            </div>

        <!-- Direita: A Visão da Tesouraria do Emissor -->
        <div class="p-6 md:w-1/2 bg-slate-800 relative flex flex-col items-center justify-center">
            
            <h2 class="text-white font-bold mb-6 flex items-center gap-2">
                <i data-lucide="building-2" class="text-slate-300"></i> Tesouraria do Emissor
            </h2>

            <!-- Calculadora de Decisão -->
            <div class="w-full max-w-sm bg-slate-700 rounded-lg p-6 shadow-lg relative overflow-hidden transition-colors duration-500" id="treasury-panel">
                
                <div class="flex justify-between items-center mb-4 border-b border-slate-600 pb-4">
                    <div class="text-xs text-slate-400">Custo Atual (Cupom)</div>
                    <div class="text-xl font-bold text-red-400">10.0% a.a.</div>
                </div>

                <div class="flex justify-between items-center mb-6">
                    <div class="text-xs text-slate-400">Custo de Mercado (Novo)</div>
                    <div class="text-xl font-bold text-green-400" id="market-cost">10.0% a.a.</div>
                </div>

                <!-- Decisão Lógica -->
                <div class="bg-slate-800 p-3 rounded text-center">
                    <div class="text-[10px] text-slate-500 uppercase mb-1">Status da Decisão</div>
                    <div id="decision-text" class="text-sm font-bold text-slate-300">Manter Dívida</div>
                </div>

                <!-- Carimbo de CALL -->
                <div id="call-stamp" class="stamp absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-4xl p-4 border-4 bg-slate-900/90 whitespace-nowrap z-20 shadow-2xl">
                    RESGATADO
                </div>

            </div>

            <!-- Explicação do Resultado para o Investidor -->
            <div id="investor-result" class="mt-8 p-4 bg-slate-900/50 rounded border border-slate-700 w-full max-w-sm">
                <h3 class="text-xs font-bold text-slate-400 uppercase mb-2">Consequência para o Investidor</h3>
                <p id="result-text" class="text-sm text-slate-300">
                    Você continua recebendo seus juros altos de 10%. O título valoriza se a taxa cair um pouco.
                </p>
            </div>

        </div>
    </div>

    <script>
        lucide.createIcons();

        // Parâmetros do Bond
        const FACE_VALUE = 1000;
        const COUPON_RATE = 10; // 10%
        const CALL_PRICE = 1020; // Preço de Resgate (levemente acima do par)
        const COUPON_AMOUNT = FACE_VALUE * (COUPON_RATE / 100); // 100

        // Elementos
        const slider = document.getElementById('rate-slider');
        const rateDisplay = document.getElementById('rate-display');
        const marketCostDisplay = document.getElementById('market-cost');
        const decisionText = document.getElementById('decision-text');
        const treasuryPanel = document.getElementById('treasury-panel');
        const callStamp = document.getElementById('call-stamp');
        const resultText = document.getElementById('result-text');
        const canvas = document.getElementById('priceCanvas');
        const ctx = canvas.getContext('2d');
        const graphLabel = document.getElementById('graph-label');

        function calculateBondPrice(marketRate) {
            // Fórmula simplificada de perpetuidade para visualização da curva
            // Preço Teórico = Cupom / Taxa
            // Limitamos a taxa minima para não dividir por zero ou explodir
            const r = Math.max(marketRate, 0.1) / 100;
            return Math.min(COUPON_AMOUNT / r, 2000); // Cap visual no gráfico
        }

        function update() {
            const marketRate = parseFloat(slider.value);
            
            // 1. Atualiza Painel da Tesouraria
            rateDisplay.innerText = `Taxa de Mercado: ${marketRate.toFixed(1)}%`;
            marketCostDisplay.innerText = `${marketRate.toFixed(1)}% a.a.`;

            // Preço teórico do título (se não fosse callable)
            const theoreticalPrice = calculateBondPrice(marketRate);
            
            // Lógica do Call: Se a taxa de mercado cair muito abaixo do cupom (mais spread de recompra)
            // Simplificação: Se o preço teórico superar o Call Price, a empresa resgata.
            // Aqui vamos definir que a empresa resgata se a taxa for < 7% (para ficar claro visualmente) ou Preço > Call Price
            
            // O "Preço Efetivo" nunca passa muito do Call Price
            const isCallTriggered = marketRate < 9.0; // Gatilho arbitrário para a animação
            const effectivePrice = isCallTriggered ? CALL_PRICE : Math.min(theoreticalPrice, CALL_PRICE + 20);

            if (isCallTriggered) {
                // ESTADO: RESGATADO
                treasuryPanel.classList.remove('bg-slate-700');
                treasuryPanel.classList.add('bg-red-900/30', 'border-2', 'border-red-500');
                decisionText.innerText = "EXERCER CALL (Recomprar)";
                decisionText.className = "text-sm font-bold text-red-400 alert-pulse";
                callStamp.classList.add('visible');
                
                resultText.innerHTML = `
                    <span class="text-red-400 font-bold">Risco de Reinvestimento:</span><br>
                    O Emissor te devolveu os R$ 1.000. Agora você é obrigado a reinvestir esse dinheiro no mercado ganhando apenas <strong>${marketRate}%</strong> (e não mais os 10% que tinha antes).
                `;
            } else {
                // ESTADO: NORMAL
                treasuryPanel.classList.add('bg-slate-700');
                treasuryPanel.classList.remove('bg-red-900/30', 'border-2', 'border-red-500');
                decisionText.innerText = "Manter Dívida (Refinanciar não compensa)";
                decisionText.className = "text-sm font-bold text-green-400";
                callStamp.classList.remove('visible');

                if (marketRate < 10) {
                    resultText.innerHTML = "Juros caíram. Seu título valorizou, mas está limitado pelo teto de resgate (Convexidade Negativa).";
                } else {
                    resultText.innerHTML = "Juros subiram. Seu título desvalorizou (está barato), mas você continua recebendo seu cupom de 10% normalmente.";
                }
            }

            drawGraph(marketRate, isCallTriggered);
        }

        function drawGraph(currentRate, isCalled) {
            // Setup Canvas
            const w = canvas.width;
            const h = canvas.height;
            const padding = 30;
            ctx.clearRect(0, 0, w, h);

            // Escalas
            // X: Taxa de 15% (Esq/Min X) a 2% (Dir/Max X) ?? Não, vamos fazer padrão:
            // Vamos inverter X: Esquerda (15%) -> Direita (2%) para combinar com a intuição "Juro cai -> Preço sobe" indo pra direita
            const minRate = 2;
            const maxRate = 15;
            // CORREÇÃO: Mapeamento padrão (Esquerda = Min, Direita = Max)
            const mapX = (rate) => padding + ((rate - minRate) / (maxRate - minRate)) * (w - 2 * padding);

            const minPrice = 600;
            const maxPrice = 1600;
            const mapY = (price) => h - padding - ((price - minPrice) / (maxPrice - minPrice)) * (h - 2 * padding);

            // Eixos
            ctx.strokeStyle = '#475569';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(padding, padding); ctx.lineTo(padding, h - padding);
            ctx.moveTo(padding, h - padding); ctx.lineTo(w - padding, h - padding);
            ctx.stroke();

            // 1. Curva "Plain Vanilla" (Fantasma/Referência)
            ctx.strokeStyle = '#475569';
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            for (let r = maxRate; r >= minRate; r -= 0.1) {
                const p = calculateBondPrice(r);
                const x = mapX(r);
                const y = mapY(p);
                if (r === maxRate) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.stroke();
            ctx.setLineDash([]);
            
            // Label Vanilla
            ctx.fillStyle = '#64748b';
            ctx.font = '10px Arial';
            ctx.fillText("Título Comum (Sem Call)", mapX(3), mapY(1500));

            // 2. Curva "Callable" (Efetiva - Com Teto)
            ctx.strokeStyle = isCalled ? '#ef4444' : '#3b82f6';
            ctx.lineWidth = 3;
            ctx.beginPath();
            for (let r = maxRate; r >= minRate; r -= 0.1) {
                let p = calculateBondPrice(r);
                // Aplica o teto do Call Price (suavizado)
                if (r < 9.0) p = CALL_PRICE; // Teto firme abaixo de 9%
                else if (r < 10.0) { 
                    // Suavização visual entre 9% e 10% para a linha não "quebrar" feio
                    // Apenas uma interpolação visual simples
                    p = Math.min(p, CALL_PRICE + (p - CALL_PRICE) * 0.1); 
                }

                // Lógica simples de teto para o gráfico
                const effectiveP = (r < 9.0) ? CALL_PRICE : Math.min(p, CALL_PRICE + (p - CALL_PRICE)*0.1); 

                const x = mapX(r);
                const y = mapY(effectiveP);
                if (r === maxRate) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.stroke();

            // Linha do Call Price
            ctx.strokeStyle = '#ef4444';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(padding, mapY(CALL_PRICE));
            ctx.lineTo(w - padding, mapY(CALL_PRICE));
            ctx.stroke();
            ctx.fillStyle = '#ef4444';
            ctx.fillText(`Preço de Resgate (R$ ${CALL_PRICE})`, w - 150, mapY(CALL_PRICE) - 5);

            // Ponto Atual
            const currentP = (currentRate < 7.5) ? CALL_PRICE : calculateBondPrice(currentRate); 
            // Ajuste visual do ponto para não fugir da linha desenhada
            const visualP = (currentRate < 7.5) ? CALL_PRICE : Math.min(currentP, CALL_PRICE + (currentP - CALL_PRICE)*0.1);

            const px = mapX(currentRate);
            const py = mapY(visualP);

            ctx.fillStyle = isCalled ? '#ef4444' : '#fff';
            ctx.beginPath();
            ctx.arc(px, py, 6, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();
        }

        slider.addEventListener('input', update);
        setTimeout(update, 100);

    </script>
</body>
</html>